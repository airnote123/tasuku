<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyLog - Cãã‚“å°‚ç”¨å­¦ç¿’ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        
        :root {
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.4);
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background: linear-gradient(135deg, #f0f4ff 0%, #e5eaff 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* ã‚°ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ åŠ¹æœ */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }

        .desktop-nav-active { 
            background: rgba(79, 70, 229, 0.1); 
            color: #4f46e5;
            box-shadow: inset 0 0 0 1px rgba(79, 70, 229, 0.2);
        }

        /* ã‚³ãƒ¼ãƒç”»é¢ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        #chatHistory::-webkit-scrollbar { width: 6px; }
        #chatHistory::-webkit-scrollbar-track { background: transparent; }
        #chatHistory::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.05); border-radius: 10px; }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }
    </style>
</head>
<body class="text-gray-800 pb-28 md:pb-8">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="glass-card sticky top-0 z-40 mb-6">
        <div class="max-w-6xl mx-auto px-6 h-18 py-4 flex items-center justify-between">
            <h1 class="text-2xl font-black text-indigo-600 flex items-center select-none tracking-tighter italic">
                <i class="fas fa-layer-group mr-3"></i> StudyLog
            </h1>
            
            <nav class="hidden md:flex items-center space-x-2 bg-white/30 p-1.5 rounded-2xl">
                <button onclick="switchTab('main')" class="nav-btn-desktop px-5 py-2.5 rounded-xl font-bold text-gray-500 hover:bg-white/50 transition-all desktop-nav-active" data-tab="main">å­¦ç¿’å…¥åŠ›</button>
                <button onclick="switchTab('coach')" class="nav-btn-desktop px-5 py-2.5 rounded-xl font-bold text-gray-500 hover:bg-white/50 transition-all" data-tab="coach">AIã‚³ãƒ¼ãƒ</button>
                <button onclick="switchTab('history')" class="nav-btn-desktop px-5 py-2.5 rounded-xl font-bold text-gray-500 hover:bg-white/50 transition-all" data-tab="history">å±¥æ­´</button>
            </nav>

            <div class="flex gap-1">
                <button onclick="toggleModal('settingsModal')" title="è¨­å®š" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-indigo-600 transition-colors bg-white/40 rounded-full"><i class="fas fa-cog"></i></button>
                <button onclick="toggleModal('dataModal')" title="ãƒ‡ãƒ¼ã‚¿ç®¡ç†" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-indigo-600 transition-colors bg-white/40 rounded-full"><i class="fas fa-database"></i></button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6">
        
        <!-- å­¦ç¿’å…¥åŠ›ã‚¿ãƒ– -->
        <div id="mainTab" class="tab-content active space-y-8 animate-in fade-in zoom-in-95 duration-500">
            
            <!-- å…¥åŠ›ã‚«ãƒ¼ãƒ‰ -->
            <div class="glass-card rounded-[3rem] p-8 md:p-12 space-y-8">
                <div class="space-y-6">
                    <div class="relative group">
                        <label class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] ml-1">ç¾åœ¨ã®ç§‘ç›®</label>
                        <input type="text" id="entrySubject" placeholder="æ•°å­¦ãƒ»è‹±èªãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãªã©" 
                               class="w-full text-2xl md:text-3xl font-black placeholder:text-gray-200 border-none bg-transparent focus:ring-0 p-0 transition-all mt-1">
                    </div>

                    <div class="relative group">
                        <label class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] ml-1">å­¦ç¿’ã®ç›®æ¨™</label>
                        <textarea id="entryDetails" placeholder="å…·ä½“çš„ã«ä½•ã‚’ã™ã‚‹ï¼Ÿï¼ˆä¾‹ï¼šå•é¡Œé›†ã®10ãƒšãƒ¼ã‚¸ã¾ã§è§£ãï¼‰" 
                                  class="w-full text-lg text-gray-600 placeholder:text-gray-200 border-none bg-transparent focus:ring-0 p-0 h-24 resize-none leading-relaxed mt-1"></textarea>
                    </div>
                </div>

                <!-- è£œè¶³ãƒ¡ãƒ¢ -->
                <div class="flex items-center gap-3 bg-white/20 p-4 rounded-[1.5rem] border border-white/30">
                    <i class="fas fa-feather-alt text-indigo-300 text-sm ml-1"></i>
                    <input type="text" id="entryMemo" placeholder="æ°—ã¥ã„ãŸã“ã¨ã€æ„Ÿæƒ³ãªã©ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰" class="flex-1 bg-transparent border-none focus:ring-0 text-sm font-bold placeholder:text-gray-400">
                </div>
            </div>

            <!-- è¨˜éŒ²æ–¹æ³•ã®é¸æŠ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- ã‚¿ã‚¤ãƒãƒ¼ãƒ‘ãƒãƒ« -->
                <div class="glass-card rounded-[3rem] p-10 flex flex-col items-center justify-center space-y-8 relative overflow-hidden">
                    <div id="timerDisplay" class="text-7xl font-mono font-bold text-indigo-600 tracking-tighter drop-shadow-sm">25:00</div>
                    
                    <div class="flex items-center gap-6">
                        <button onclick="resetTimer()" class="w-14 h-14 rounded-full bg-white/50 text-gray-400 hover:text-gray-600 flex items-center justify-center border border-white/50"><i class="fas fa-redo-alt"></i></button>
                        <button id="btnStartStop" onclick="toggleTimer()" class="px-12 py-5 bg-indigo-600 text-white rounded-3xl font-black hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-200 active:scale-95 text-lg">é–‹å§‹</button>
                        <button id="btnSaveTimer" onclick="saveSession('timer')" class="hidden w-14 h-14 rounded-full bg-green-500 text-white flex items-center justify-center animate-bounce shadow-lg"><i class="fas fa-check"></i></button>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="setTimerDuration(25)" class="text-[11px] font-black bg-white/40 px-4 py-1.5 rounded-full text-gray-500 hover:bg-indigo-600 hover:text-white transition-all">é›†ä¸­ 25åˆ†</button>
                        <button onclick="setTimerDuration(50)" class="text-[11px] font-black bg-white/40 px-4 py-1.5 rounded-full text-gray-500 hover:bg-indigo-600 hover:text-white transition-all">æ·±ã 50åˆ†</button>
                        <button onclick="setTimerDuration(5)" class="text-[11px] font-black bg-white/40 px-4 py-1.5 rounded-full text-gray-500 hover:bg-teal-500 hover:text-white transition-all">ä¼‘æ†© 5åˆ†</button>
                    </div>
                </div>

                <!-- æ‰‹å‹•å…¥åŠ›ãƒ‘ãƒãƒ« -->
                <div class="glass-card rounded-[3rem] p-10 flex flex-col space-y-6">
                    <div class="space-y-4 flex-1">
                        <div class="bg-white/20 rounded-3xl p-6 border border-white/30">
                            <label class="block text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">å­¦ç¿’æ™‚é–“ (åˆ†)</label>
                            <input type="number" id="manualMinutes" placeholder="0" class="w-full bg-transparent border-none focus:ring-0 text-5xl font-black p-0 text-indigo-700">
                        </div>
                        <div class="bg-white/20 rounded-3xl p-6 border border-white/30">
                            <label class="block text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">å­¦ç¿’æ—¥</label>
                            <input type="date" id="manualDate" class="w-full bg-transparent border-none focus:ring-0 font-black p-0 text-gray-600 text-lg">
                        </div>
                    </div>

                    <button onclick="saveSession('manual')" class="w-full py-5 bg-white text-indigo-600 border border-indigo-100 rounded-3xl font-black hover:bg-indigo-600 hover:text-white transition-all shadow-lg active:scale-95">
                        è¨˜éŒ²ã‚’ä¿å­˜
                    </button>
                </div>
            </div>
        </div>

        <!-- AIã‚³ãƒ¼ãƒã‚¿ãƒ– -->
        <div id="coachTab" class="tab-content animate-in slide-in-from-right-10 duration-500">
            <div class="flex flex-col gap-6 min-h-[750px] md:min-h-[850px]">
                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="glass-card p-6 rounded-[2rem] flex items-center justify-between">
                        <div>
                            <p class="text-[10px] font-black text-gray-400 uppercase">ç¶™ç¶šæ—¥æ•°</p>
                            <span id="streakDisplay" class="text-2xl font-black text-indigo-600">0æ—¥</span>
                        </div>
                        <i class="fas fa-fire text-orange-400 text-2xl"></i>
                    </div>
                    <div class="glass-card p-6 rounded-[2rem] flex items-center justify-between">
                        <div>
                            <p class="text-[10px] font-black text-gray-400 uppercase">ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯</p>
                            <span id="rankDisplay" class="text-sm font-black text-gray-700">ğŸŒ± è¦‹ç¿’ã„</span>
                        </div>
                        <i class="fas fa-award text-yellow-400 text-2xl"></i>
                    </div>
                </div>

                <!-- ã‚³ãƒ¼ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆç¸¦é•·ï¼‰ -->
                <div class="flex-1 glass-card rounded-[3rem] overflow-hidden flex flex-col border border-white/50 shadow-2xl">
                    <div class="p-6 border-b border-white/20 bg-white/10 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white shadow-lg">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h3 class="font-black text-gray-800">AIã‚³ãƒ¼ãƒ</h3>
                            <p class="text-[10px] font-bold text-green-500 flex items-center gap-1">
                                <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> å¾…æ©Ÿä¸­
                            </p>
                        </div>
                    </div>

                    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
                    <div id="chatHistory" class="flex-1 overflow-y-auto p-8 space-y-6"></div>

                    <div id="typingIndicator" class="hidden px-8 py-2 text-[10px] font-black text-indigo-400 tracking-widest"><span class="loading-dots italic">æ€è€ƒä¸­</span></div>
                    
                    <!-- ãƒãƒ£ãƒƒãƒˆå…¥åŠ› -->
                    <div class="p-6 bg-white/20 border-t border-white/20">
                        <form onsubmit="handleChatSubmit(event)" class="flex gap-3 items-center bg-white/60 p-2 rounded-[2rem] shadow-inner">
                            <input type="text" id="chatInput" placeholder="å‹‰å¼·ã®æ‚©ã¿ã‚„ç›®æ¨™ã‚’è©±ã—ã¦ã¿ã‚ˆã†..." 
                                   class="flex-1 bg-transparent border-none focus:ring-0 px-4 py-3 text-sm font-bold text-gray-700 placeholder:text-gray-400">
                            <button type="submit" class="bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg hover:bg-indigo-700 transition-all active:scale-90 flex items-center justify-center">
                                <i class="fas fa-paper-plane text-sm"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- å±¥æ­´ã‚¿ãƒ– -->
        <div id="historyTab" class="tab-content animate-in fade-in duration-500 space-y-8">
            <div class="glass-card p-10 rounded-[3.5rem] relative overflow-hidden">
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                    <div>
                        <p class="text-indigo-400 text-[10px] font-black uppercase tracking-[0.3em] mb-3">å­¦ç¿’ã‚¹ã‚¿ãƒƒãƒ„</p>
                        <h2 class="text-6xl font-black text-gray-800 leading-none"><span id="totalMinutesDisplay">0</span> <span class="text-2xl text-gray-300">åˆ†</span></h2>
                    </div>
                    <div class="flex gap-10">
                        <div class="text-right">
                            <p class="text-gray-400 text-[10px] font-black uppercase tracking-widest mb-1">åˆè¨ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</p>
                            <p id="sessionCountDisplay" class="text-3xl font-black text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="absolute -right-20 -top-20 w-64 h-64 bg-indigo-100/30 rounded-full blur-3xl"></div>
            </div>
            <div id="historyList" class="space-y-6"></div>
        </div>
    </main>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šè¨­å®š -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-xl hidden items-center justify-center p-6 z-50">
        <div class="glass-card rounded-[3rem] p-10 w-full max-w-md space-y-8">
            <h3 class="text-2xl font-black text-center">è¨­å®š</h3>
            <div class="space-y-2">
                <label class="text-[10px] font-black text-indigo-400 uppercase tracking-widest ml-1">Gemini APIã‚­ãƒ¼</label>
                <input type="password" id="userApiKey" placeholder="APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„" class="w-full p-5 bg-white/40 rounded-3xl border-none outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm">
            </div>
            <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black shadow-xl shadow-indigo-100">è¨­å®šã‚’ä¿å­˜</button>
            <button onclick="toggleModal('settingsModal')" class="w-full text-gray-400 font-black text-xs uppercase tracking-widest">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
    <div id="dataModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-xl hidden items-center justify-center p-6 z-50">
        <div class="glass-card rounded-[3rem] p-10 w-full max-w-md space-y-6">
            <h3 class="text-2xl font-black text-center text-gray-800">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼</h3>
            <button onclick="exportData()" class="w-full bg-white/60 py-4 rounded-2xl font-black text-gray-600 border border-white">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
            <textarea id="importText" placeholder="JSONãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘..." class="w-full h-40 p-5 bg-white/40 rounded-3xl text-xs font-mono border-none outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
            <button onclick="importData()" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black shadow-xl">ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ</button>
            <button onclick="toggleModal('dataModal')" class="w-full text-gray-400 font-black text-xs uppercase tracking-widest">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="md:hidden fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] glass-card rounded-[2.5rem] flex justify-around p-3 z-50 border border-white/40">
        <button onclick="switchTab('main')" class="nav-btn-mobile flex flex-col items-center p-3 w-full text-indigo-600" data-tab="main"><i class="fas fa-th-large text-lg"></i></button>
        <button onclick="switchTab('coach')" class="nav-btn-mobile flex flex-col items-center p-3 w-full text-gray-400" data-tab="coach"><i class="fas fa-comment-alt text-lg"></i></button>
        <button onclick="switchTab('history')" class="nav-btn-mobile flex flex-col items-center p-3 w-full text-gray-400" data-tab="history"><i class="fas fa-list-ul text-lg"></i></button>
    </nav>

    <script>
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        let internalApiKey = localStorage.getItem('gemini_api_key') || "";
        let sessions = JSON.parse(localStorage.getItem('studySessions_v4') || '[]');
        let currentTimer = { timeLeft: 25 * 60, isRunning: false, duration: 25 };
        let timerInterval = null;

        window.onload = () => {
            document.getElementById('userApiKey').value = internalApiKey;
            document.getElementById('manualDate').value = new Date().toLocaleDateString('sv-SE');
            renderHistory();
            updateStats();
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            document.querySelectorAll('.nav-btn-mobile, .nav-btn-desktop').forEach(btn => {
                const isActive = btn.dataset.tab === tabId;
                if (btn.classList.contains('nav-btn-mobile')) {
                    btn.classList.toggle('text-indigo-600', isActive);
                    btn.classList.toggle('text-gray-400', !isActive);
                } else {
                    btn.classList.toggle('desktop-nav-active', isActive);
                }
            });
            if(tabId === 'coach' && document.getElementById('chatHistory').children.length === 0) initCoach();
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        // --- ã‚¿ã‚¤ãƒãƒ¼å‡¦ç† ---
        function setTimerDuration(mins) {
            currentTimer.duration = mins;
            currentTimer.timeLeft = mins * 60;
            currentTimer.isRunning = false;
            clearInterval(timerInterval);
            updateTimerDisplay();
            document.getElementById('btnStartStop').innerText = "é–‹å§‹";
            document.getElementById('btnSaveTimer').classList.add('hidden');
        }

        function updateTimerDisplay() {
            const m = Math.floor(currentTimer.timeLeft / 60);
            const s = currentTimer.timeLeft % 60;
            document.getElementById('timerDisplay').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function toggleTimer() {
            currentTimer.isRunning = !currentTimer.isRunning;
            const btn = document.getElementById('btnStartStop');
            if(currentTimer.isRunning) {
                btn.innerText = "ä¸€æ™‚åœæ­¢";
                timerInterval = setInterval(() => {
                    currentTimer.timeLeft--;
                    updateTimerDisplay();
                    if(currentTimer.timeLeft <= 0) {
                        clearInterval(timerInterval);
                        currentTimer.isRunning = false;
                        btn.innerText = "å®Œäº†ï¼";
                        document.getElementById('btnSaveTimer').classList.remove('hidden');
                    }
                }, 1000);
            } else {
                btn.innerText = "å†é–‹";
                clearInterval(timerInterval);
            }
        }

        function resetTimer() { setTimerDuration(currentTimer.duration); }

        // --- ãƒ‡ãƒ¼ã‚¿å‡¦ç† ---
        function saveSession(method) {
            const subject = document.getElementById('entrySubject').value.trim() || "æœªè¨­å®šã®ãƒŸãƒƒã‚·ãƒ§ãƒ³";
            const details = document.getElementById('entryDetails').value.trim();
            const memo = document.getElementById('entryMemo').value.trim();
            let mins = 0;
            let date = new Date().toLocaleDateString('sv-SE');

            if(method === 'timer') {
                mins = currentTimer.duration;
            } else {
                mins = parseInt(document.getElementById('manualMinutes').value) || 0;
                date = document.getElementById('manualDate').value;
            }

            if(mins <= 0) return alert("å­¦ç¿’æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const newSession = {
                id: Date.now(),
                subject,
                details,
                memo,
                minutes: mins,
                date,
                type: method
            };

            sessions.unshift(newSession);
            localStorage.setItem('studySessions_v4', JSON.stringify(sessions));
            
            ['entrySubject', 'entryDetails', 'entryMemo', 'manualMinutes'].forEach(id => document.getElementById(id).value = '');
            if(method === 'timer') resetTimer();
            
            renderHistory();
            updateStats();
            switchTab('history');
        }

        function deleteSession(id) {
            if(confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                sessions = sessions.filter(s => s.id !== id);
                localStorage.setItem('studySessions_v4', JSON.stringify(sessions));
                renderHistory();
                updateStats();
            }
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            const grouped = sessions.reduce((acc, s) => {
                const d = s.date; if(!acc[d]) acc[d] = { total: 0, items: [] };
                acc[d].total += s.minutes; acc[d].items.push(s); return acc;
            }, {});

            Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
                const group = grouped[date];
                const section = document.createElement('div');
                section.className = "space-y-4";
                section.innerHTML = `
                    <div class="px-6 flex justify-between items-center">
                        <span class="text-xs font-black text-gray-400 uppercase tracking-widest">${date}</span>
                        <div class="h-[1px] flex-1 mx-6 bg-gray-200"></div>
                        <span class="text-xs font-black text-indigo-400">${group.total}åˆ†</span>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        ${group.items.map(s => `
                            <div class="glass-card rounded-[2rem] p-6 hover:bg-white/60 transition-all flex gap-5">
                                <div class="w-12 h-12 shrink-0 rounded-[1.2rem] flex items-center justify-center ${s.type === 'timer' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100' : 'bg-white border-2 border-indigo-100 text-indigo-500'}">
                                    <i class="fas ${s.type === 'timer' ? 'fa-hourglass-start' : 'fa-edit'}"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-black text-gray-800 text-lg leading-tight truncate pr-4">${s.subject}</h4>
                                        <span class="text-[10px] font-black bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full shrink-0">${s.minutes} åˆ†</span>
                                    </div>
                                    ${s.details ? `<p class="text-sm text-gray-500 leading-relaxed mb-3">${s.details.replace(/\n/g, '<br>')}</p>` : ''}
                                    ${s.memo ? `<div class="inline-flex items-center gap-2 bg-white/40 px-3 py-1.5 rounded-xl text-[10px] font-bold text-gray-400 border border-white/50 italic">"${s.memo}"</div>` : ''}
                                </div>
                                <button onclick="deleteSession(${s.id})" class="text-gray-200 hover:text-red-400 transition-colors self-start p-1"><i class="fas fa-times"></i></button>
                            </div>
                        `).join('')}
                    </div>
                `;
                list.appendChild(section);
            });
        }

        function updateStats() {
            const total = sessions.reduce((acc, s) => acc + s.minutes, 0);
            document.getElementById('totalMinutesDisplay').innerText = total;
            document.getElementById('sessionCountDisplay').innerText = sessions.length;
            
            const dates = [...new Set(sessions.map(s => s.date))].sort((a,b) => new Date(b) - new Date(a));
            let streak = 0;
            const today = new Date().toLocaleDateString('sv-SE');
            if(dates.length > 0 && (dates[0] === today || new Date(dates[0]) >= new Date(Date.now() - 86400000))) {
                streak = 1;
                for(let i=0; i<dates.length-1; i++){
                    if((new Date(dates[i]) - new Date(dates[i+1]))/86400000 <= 1.1) streak++;
                    else break;
                }
            }
            document.getElementById('streakDisplay').innerText = `${streak}æ—¥`;
            
            const h = total / 60;
            let rank = { t: "è¦‹ç¿’ã„", i: "ğŸŒ±" };
            if(h >= 50) rank = { t: "ä¼èª¬", i: "ğŸ‘‘" };
            else if(h >= 20) rank = { t: "ç†Ÿç·´è€…", i: "ğŸ“" };
            else if(h >= 5) rank = { t: "åŠªåŠ›å®¶", i: "ğŸ“˜" };
            document.getElementById('rankDisplay').innerText = `${rank.i} ${rank.t}`;
        }

        // --- AIã‚³ãƒ¼ãƒå‡¦ç† ---
        async function callGemini(prompt, systemPrompt) {
            if(!internalApiKey) return "Cãã‚“ï¼è¨­å®šã‹ã‚‰APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã­ã€‚";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${internalApiKey}`;
            try {
                const res = await fetch(url, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }], 
                        systemInstruction: { parts: [{ text: systemPrompt }] } 
                    }) 
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return "Cãã‚“ï¼æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ã¿ã¦ã­ã€‚"; }
        }

        function appendMessage(role, text) {
            const container = document.getElementById('chatHistory');
            const msg = document.createElement('div');
            msg.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in slide-in-from-bottom-5`;
            msg.innerHTML = `
                <div class="max-w-[85%] p-5 rounded-[2rem] text-[13px] font-bold leading-relaxed shadow-sm ${role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white/80 border border-white/50 text-gray-800 rounded-tl-none'} ">
                    ${text}
                </div>
            `;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function initCoach() {
            appendMessage('assistant', `Cãã‚“ï¼å­¦ç¿’å…¥åŠ›ã®æº–å‚™ã¯ã§ããŸï¼Ÿ ä»Šæ—¥ã®ç›®æ¨™ã‚„ã€å‹‰å¼·ã®æ‚©ã¿ãŒã‚ã‚Œã°ã„ã¤ã§ã‚‚ã‚³ãƒ¼ãƒã«ç›¸è«‡ã—ã¦ã­ï¼`);
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;
            appendMessage('user', text);
            input.value = '';
            document.getElementById('typingIndicator').classList.remove('hidden');
            const system = `ã‚ãªãŸã¯Cãã‚“ã®AIå­¦ç¿’ã‚³ãƒ¼ãƒã§ã™ã€‚
ãƒ»å›ç­”ã¯å¿…ãšã€ŒCãã‚“ï¼ã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚
ãƒ»ãƒã‚¸ãƒ†ã‚£ãƒ–ã§ã‚„ã‚‹æ°—ãŒå‡ºã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚
ãƒ»è¦ªã—ã¿ã‚„ã™ã„æ—¥æœ¬èªã§ã€è¤‡é›‘ãªè¡¨ç¾ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
ãƒ»ç¾åœ¨ã®åˆè¨ˆå­¦ç¿’æ™‚é–“ï¼š${document.getElementById('totalMinutesDisplay').innerText}åˆ†
ãƒ»ç¾åœ¨ã®ç¶™ç¶šæ—¥æ•°ï¼š${document.getElementById('streakDisplay').innerText}`;

            const response = await callGemini(text, system);
            document.getElementById('typingIndicator').classList.add('hidden');
            appendMessage('assistant', response);
        }

        function saveSettings() {
            internalApiKey = document.getElementById('userApiKey').value.trim();
            localStorage.setItem('gemini_api_key', internalApiKey);
            alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
            toggleModal('settingsModal');
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
            el.classList.toggle('flex');
        }

        function exportData() {
            const text = JSON.stringify(sessions);
            const el = document.createElement('textarea');
            el.value = text; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¢å¸³ãªã©ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
        }

        function importData() {
            try {
                const data = JSON.parse(document.getElementById('importText').value);
                sessions = data;
                localStorage.setItem('studySessions_v4', JSON.stringify(sessions));
                renderHistory(); updateStats();
                alert("ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
                toggleModal('dataModal');
            } catch(e) { alert("å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"); }
        }
    </script>
</body>
</html>
