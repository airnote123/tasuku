<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyLog - Cãã‚“å°‚ç”¨å­¦ç¿’ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
        
        /* Desktop specific styles */
        @media (min-width: 768px) {
            .desktop-nav-active {
                background-color: #f3f4f6;
                color: #4f46e5;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800 pb-20 md:pb-0">

    <!-- Header -->
    <header class="bg-white border-b sticky top-0 z-10 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-black text-indigo-600 flex items-center select-none">
                <i class="fas fa-book-open mr-2"></i> StudyLog
            </h1>
            
            <!-- Desktop Navigation -->
            <nav class="hidden md:flex items-center space-x-1">
                <button onclick="switchTab('timer')" class="nav-btn-desktop px-4 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition-all desktop-nav-active" data-tab="timer">
                    <i class="fas fa-clock mr-1"></i> ã‚¿ã‚¤ãƒãƒ¼
                </button>
                <button onclick="switchTab('manual')" class="nav-btn-desktop px-4 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition-all" data-tab="manual">
                    <i class="fas fa-plus-circle mr-1"></i> æ‰‹å‹•å…¥åŠ›
                </button>
                <button onclick="switchTab('coach')" class="nav-btn-desktop px-4 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition-all" data-tab="coach">
                    <i class="fas fa-robot mr-1"></i> AIã‚³ãƒ¼ãƒ
                </button>
                <button onclick="switchTab('history')" class="nav-btn-desktop px-4 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition-all" data-tab="history">
                    <i class="fas fa-list mr-1"></i> å±¥æ­´
                </button>
            </nav>

            <div class="flex gap-2">
                <button onclick="toggleModal('dataModal')" title="ãƒ‡ãƒ¼ã‚¿ç®¡ç†" class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                    <i class="fas fa-save text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-4 md:p-12">
        
        <!-- Timer Tab -->
        <div id="timerTab" class="tab-content active animate-in fade-in">
            <div class="flex flex-col items-center justify-center space-y-8 py-4">
                <div class="flex space-x-4 bg-gray-200 p-1 rounded-xl">
                    <button id="btnStudyMode" onclick="switchMode('study')" class="px-8 py-2 rounded-lg font-bold transition-all bg-indigo-600 text-white shadow-md">å­¦ç¿’</button>
                    <button id="btnBreakMode" onclick="switchMode('break')" class="px-8 py-2 rounded-lg font-bold transition-all text-gray-500 hover:bg-gray-300">ä¼‘æ†©</button>
                </div>
                <div id="timerDisplay" class="text-8xl md:text-9xl font-mono font-bold tracking-tighter text-indigo-600 drop-shadow-sm">25:00</div>
                
                <div class="w-full max-w-sm grid grid-cols-1 gap-4">
                    <div class="relative">
                        <i class="fas fa-tag absolute left-4 top-1/2 -translate-y-1/2 text-gray-300"></i>
                        <input type="text" id="timerSubject" placeholder="å­¦ç¿’ã—ã¦ã„ã‚‹ç§‘ç›®..." class="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                </div>

                <div class="flex items-center space-x-6">
                    <button onclick="resetTimer()" class="w-14 h-14 rounded-full bg-white border border-gray-200 text-gray-400 hover:text-gray-600 hover:border-gray-300 transition-all shadow-sm">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button id="btnStartStop" onclick="toggleTimer()" class="flex items-center justify-center w-24 h-24 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 active:scale-95 shadow-xl transition-all">
                        <i id="playIcon" class="fas fa-play text-3xl"></i>
                    </button>
                    <button id="btnSaveSession" onclick="saveTimerSession()" class="hidden w-14 h-14 rounded-full bg-green-500 text-white hover:bg-green-600 shadow-lg animate-bounce flex items-center justify-center">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Manual Tab -->
        <div id="manualTab" class="tab-content animate-in fade-in">
            <div class="max-w-xl mx-auto bg-white p-8 rounded-3xl border border-gray-100 shadow-xl">
                <div class="mb-8">
                    <h3 class="text-2xl font-black text-gray-800 flex items-center">
                        <i class="fas fa-pen-nib mr-3 text-indigo-500"></i> å­¦ç¿’ã‚’è¨˜éŒ²
                    </h3>
                    <p class="text-gray-400 text-sm mt-1">ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã‚ãªã‹ã£ãŸå­¦ç¿’ã‚’å¾Œã‹ã‚‰å…¥åŠ›ã§ãã¾ã™ã€‚</p>
                </div>
                
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700 ml-1">æ—¥ä»˜</label>
                            <input type="date" id="manualDate" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700 ml-1">å­¦ç¿’æ™‚é–“ (åˆ†)</label>
                            <input type="number" id="manualMinutes" min="1" placeholder="ä¾‹: 60" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700 ml-1">ç§‘ç›®å</label>
                        <input type="text" id="manualSubject" placeholder="ä¾‹: æ•°å­¦ã€è‹±èª..." class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700 ml-1">ãƒ¡ãƒ¢ãƒ»å†…å®¹</label>
                        <textarea id="manualDetails" placeholder="å…·ä½“çš„ã«ä½•ã‚’ã—ãŸã‹è¨˜éŒ²ã—ã¾ã—ã‚‡ã†" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none h-32 resize-none transition-all"></textarea>
                    </div>
                    <button onclick="saveManualSession()" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 flex justify-center items-center active:scale-[0.98]">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>

        <!-- Coach Tab -->
        <div id="coachTab" class="tab-content animate-in fade-in h-[calc(100vh-280px)] md:h-[600px] flex flex-col space-y-4">
            <div class="grid grid-cols-2 gap-4 shrink-0">
                <div class="bg-white p-5 rounded-2xl border border-gray-100 flex items-center justify-between shadow-sm">
                    <div class="flex items-center"><i class="fas fa-fire text-orange-500 mr-3 text-xl"></i> <span class="text-sm font-bold text-gray-500">ç¶™ç¶šæ—¥æ•°</span></div>
                    <span id="streakDisplay" class="text-2xl font-black text-gray-800">0æ—¥</span>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-gray-100 flex items-center justify-between shadow-sm">
                    <div class="flex items-center"><i class="fas fa-medal text-yellow-500 mr-3 text-xl"></i> <span class="text-sm font-bold text-gray-500">ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯</span></div>
                    <span id="rankDisplay" class="text-xl font-black text-gray-800">ğŸŒ± è¦‹ç¿’ã„</span>
                </div>
            </div>
            <div class="flex-1 bg-white rounded-3xl border border-gray-200 shadow-inner flex flex-col overflow-hidden">
                <div id="chatHistory" class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/50">
                    <!-- Messages -->
                </div>
                <div id="typingIndicator" class="hidden px-6 py-2 bg-transparent text-xs text-indigo-400 font-bold">
                    <span class="loading-dots">AIã‚³ãƒ¼ãƒãŒå…¥åŠ›ä¸­</span>
                </div>
                <form onsubmit="handleChatSubmit(event)" class="p-4 bg-white border-t flex gap-3">
                    <input type="text" id="chatInput" placeholder="å­¦ç¿’ã®æ‚©ã¿ã‚„ç›®æ¨™ã‚’è©±ã—ã¦ã¿ã¦ã­..." class="flex-1 bg-gray-100 rounded-2xl px-6 py-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm transition-all border-none">
                    <button type="submit" class="bg-indigo-600 text-white w-14 h-14 rounded-2xl hover:bg-indigo-700 transition-all flex items-center justify-center shadow-md">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content animate-in fade-in space-y-8">
            <div class="bg-indigo-600 p-8 rounded-3xl text-white shadow-xl shadow-indigo-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <p class="text-indigo-100 font-bold mb-1">Total Study Time</p>
                    <h2 class="text-4xl font-black">ç´¯è¨ˆ <span id="totalMinutesDisplay">0</span> åˆ†</h2>
                </div>
                <div class="h-12 w-px bg-indigo-500 hidden md:block"></div>
                <div>
                    <p class="text-indigo-100 font-bold mb-1">Sessions</p>
                    <h2 class="text-2xl font-black"><span id="sessionCountDisplay">0</span> è¨˜éŒ²</h2>
                </div>
            </div>
            <div id="historyList" class="space-y-6">
                <!-- History -->
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="dataModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-black"><i class="fas fa-database mr-2 text-indigo-500"></i> ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                <button onclick="toggleModal('dataModal')" class="w-10 h-10 hover:bg-gray-100 rounded-full transition-colors flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-6">
                <div class="p-5 bg-indigo-50 rounded-2xl border border-indigo-100">
                    <p class="font-bold text-indigo-900 mb-1">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</p>
                    <p class="text-xs text-indigo-700 mb-4">ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç§»ã™éš›ã«ãŠä½¿ã„ãã ã•ã„ã€‚</p>
                    <button onclick="exportData()" class="w-full bg-white text-indigo-600 border border-indigo-200 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-indigo-600 hover:text-white transition-all active:scale-95">
                        <i class="fas fa-copy"></i> ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
                    </button>
                </div>
                <div class="space-y-3">
                    <p class="font-bold text-gray-800 ml-1">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</p>
                    <textarea id="importText" placeholder="JSONãƒ†ã‚­ã‚¹ãƒˆã‚’ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆ..." class="w-full h-32 p-4 bg-gray-50 rounded-2xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none text-xs font-mono"></textarea>
                    <button onclick="importData()" class="w-full bg-gray-800 text-white py-4 rounded-2xl font-bold hover:bg-black transition-all">
                        ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Nav -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 z-40 shadow-lg">
        <button onclick="switchTab('timer')" class="nav-btn-mobile flex flex-col items-center p-2 w-full text-indigo-600" data-tab="timer"><i class="fas fa-clock"></i><span class="text-[10px] mt-1 font-bold">ã‚¿ã‚¤ãƒãƒ¼</span></button>
        <button onclick="switchTab('manual')" class="nav-btn-mobile flex flex-col items-center p-2 w-full text-gray-400" data-tab="manual"><i class="fas fa-plus-circle"></i><span class="text-[10px] mt-1 font-bold">å…¥åŠ›</span></button>
        <button onclick="switchTab('coach')" class="nav-btn-mobile flex flex-col items-center p-2 w-full text-gray-400" data-tab="coach"><i class="fas fa-robot"></i><span class="text-[10px] mt-1 font-bold">ã‚³ãƒ¼ãƒ</span></button>
        <button onclick="switchTab('history')" class="nav-btn-mobile flex flex-col items-center p-2 w-full text-gray-400" data-tab="history"><i class="fas fa-list"></i><span class="text-[10px] mt-1 font-bold">å±¥æ­´</span></button>
    </nav>

    <script>
        // --- API Config ---
        const apiKey = ""; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

        // --- State ---
        let sessions = JSON.parse(localStorage.getItem('studySessions_v2') || '[]');
        let currentTimer = { timeLeft: 25 * 60, isRunning: false, mode: 'study' };
        let timerInterval = null;

        // --- Tab Switching ---
        function switchTab(tabId) {
            // Content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            // Mobile Nav UI
            document.querySelectorAll('.nav-btn-mobile').forEach(btn => {
                btn.classList.toggle('text-indigo-600', btn.dataset.tab === tabId);
                btn.classList.toggle('text-gray-400', btn.dataset.tab !== tabId);
            });

            // Desktop Nav UI
            document.querySelectorAll('.nav-btn-desktop').forEach(btn => {
                btn.classList.toggle('desktop-nav-active', btn.dataset.tab === tabId);
                btn.classList.toggle('text-gray-500', btn.dataset.tab !== tabId);
            });

            if(tabId === 'coach' && document.getElementById('chatHistory').children.length === 0) {
                initCoach();
            }
        }

        // --- Core ---
        function saveToStorage() {
            localStorage.setItem('studySessions_v2', JSON.stringify(sessions));
            renderHistory();
            updateStats();
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
            el.classList.toggle('flex');
        }

        // --- Timer ---
        function updateTimerDisplay() {
            const m = Math.floor(currentTimer.timeLeft / 60);
            const s = currentTimer.timeLeft % 60;
            document.getElementById('timerDisplay').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function switchMode(mode) {
            currentTimer.mode = mode;
            currentTimer.isRunning = false;
            clearInterval(timerInterval);
            currentTimer.timeLeft = (mode === 'study' ? 25 : 5) * 60;
            
            const studyBtn = document.getElementById('btnStudyMode');
            const breakBtn = document.getElementById('btnBreakMode');
            const display = document.getElementById('timerDisplay');
            
            if(mode === 'study') {
                studyBtn.className = "px-8 py-2 rounded-lg font-bold transition-all bg-indigo-600 text-white shadow-md";
                breakBtn.className = "px-8 py-2 rounded-lg font-bold transition-all text-gray-500 hover:bg-gray-300";
                display.classList.replace('text-teal-500', 'text-indigo-600');
            } else {
                breakBtn.className = "px-8 py-2 rounded-lg font-bold transition-all bg-teal-500 text-white shadow-md";
                studyBtn.className = "px-8 py-2 rounded-lg font-bold transition-all text-gray-500 hover:bg-gray-300";
                display.classList.replace('text-indigo-600', 'text-teal-500');
            }
            
            updateTimerDisplay();
            document.getElementById('playIcon').className = "fas fa-play text-3xl";
            document.getElementById('btnSaveSession').classList.add('hidden');
        }

        function toggleTimer() {
            currentTimer.isRunning = !currentTimer.isRunning;
            const icon = document.getElementById('playIcon');
            
            if(currentTimer.isRunning) {
                icon.className = "fas fa-pause text-3xl";
                timerInterval = setInterval(() => {
                    currentTimer.timeLeft--;
                    updateTimerDisplay();
                    if(currentTimer.timeLeft <= 0) {
                        clearInterval(timerInterval);
                        currentTimer.isRunning = false;
                        document.getElementById('btnSaveSession').classList.remove('hidden');
                        icon.className = "fas fa-play text-3xl";
                    }
                }, 1000);
            } else {
                icon.className = "fas fa-play text-3xl";
                clearInterval(timerInterval);
            }
        }

        function resetTimer() { switchMode(currentTimer.mode); }

        function saveTimerSession() {
            const minutes = currentTimer.mode === 'study' ? 25 : 5;
            const subject = document.getElementById('timerSubject').value || (currentTimer.mode === 'study' ? 'é›†ä¸­å­¦ç¿’' : 'ä¼‘æ†©');
            addSession(minutes, 'timer', subject, '');
            resetTimer();
            document.getElementById('timerSubject').value = '';
        }

        // --- Data ---
        function addSession(minutes, type, subject, details, customDate = null) {
            const session = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                date: customDate || new Date().toLocaleDateString('sv-SE'),
                timestamp: new Date().toISOString(),
                minutes: parseInt(minutes),
                type,
                subject: subject || 'å­¦ç¿’',
                details: details || ''
            };
            sessions.unshift(session);
            saveToStorage();
        }

        function saveManualSession() {
            const minutes = document.getElementById('manualMinutes').value;
            const date = document.getElementById('manualDate').value;
            if(!minutes || !date) return alert("æ—¥ä»˜ã¨æ™‚é–“ã¯å¿…é ˆã§ã™ï¼");
            
            addSession(minutes, 'manual', document.getElementById('manualSubject').value, document.getElementById('manualDetails').value, date);
            
            // Clear
            ['manualMinutes', 'manualSubject', 'manualDetails'].forEach(id => document.getElementById(id).value = '');
            switchTab('history');
        }

        function deleteSession(id) {
            if(confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                sessions = sessions.filter(s => s.id !== id);
                saveToStorage();
            }
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            const grouped = sessions.reduce((acc, s) => {
                const d = s.date; if(!acc[d]) acc[d] = { total: 0, items: [] };
                acc[d].total += s.minutes; acc[d].items.push(s); return acc;
            }, {});
            
            const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
            
            if(sessions.length === 0) {
                list.innerHTML = `<div class="bg-white p-20 rounded-3xl border border-dashed border-gray-200 text-center text-gray-400 font-bold">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’å›ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</div>`;
                return;
            }

            sortedDates.forEach(date => {
                const dayGroup = grouped[date];
                const card = document.createElement('div');
                card.className = "bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden";
                card.innerHTML = `
                    <div class="bg-slate-50 px-6 py-4 flex justify-between items-center border-b border-gray-100">
                        <h4 class="font-black text-gray-700 flex items-center"><i class="far fa-calendar-check mr-3 text-indigo-500"></i> ${date}</h4>
                        <span class="bg-white px-4 py-1 rounded-full text-xs font-black text-indigo-600 border shadow-sm">${dayGroup.total} åˆ†</span>
                    </div>
                    <div class="divide-y divide-gray-50">
                        ${dayGroup.items.map(item => `
                            <div class="px-6 py-5 flex justify-between items-center group hover:bg-slate-50/50 transition-colors">
                                <div class="flex items-center space-x-5">
                                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center ${item.type === 'timer' ? 'bg-indigo-50 text-indigo-600' : 'bg-orange-50 text-orange-600'} text-xl">
                                        <i class="fas ${item.type === 'timer' ? 'fa-hourglass-half' : 'fa-keyboard'}"></i>
                                    </div>
                                    <div>
                                        <p class="font-black text-gray-800 leading-none mb-1">${item.subject}</p>
                                        <p class="text-xs text-gray-400 font-bold">${item.minutes}åˆ† ${item.details ? 'â€¢ ' + item.details : ''}</p>
                                    </div>
                                </div>
                                <button onclick="deleteSession('${item.id}')" class="text-gray-200 hover:text-red-500 p-2 md:opacity-0 group-hover:opacity-100 transition-all">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function updateStats() {
            const total = sessions.reduce((acc, s) => acc + s.minutes, 0);
            document.getElementById('totalMinutesDisplay').innerText = total;
            document.getElementById('sessionCountDisplay').innerText = sessions.length;
            
            // Streak
            const uniqueDates = [...new Set(sessions.map(s => s.date))].sort((a,b) => new Date(b) - new Date(a));
            let streak = 0;
            const today = new Date().toLocaleDateString('sv-SE');
            const yesterday = new Date(Date.now() - 86400000).toLocaleDateString('sv-SE');
            
            if(uniqueDates.length > 0 && (uniqueDates[0] === today || uniqueDates[0] === yesterday)) {
                streak = 1;
                for(let i=0; i < uniqueDates.length - 1; i++) {
                    const d1 = new Date(uniqueDates[i]);
                    const d2 = new Date(uniqueDates[i+1]);
                    if(Math.round((d1-d2)/(1000*60*60*24)) === 1) streak++;
                    else break;
                }
            }
            document.getElementById('streakDisplay').innerText = `${streak}æ—¥`;
            
            const hours = total / 60;
            let rank = { title: "è¦‹ç¿’ã„", icon: "ğŸŒ±" };
            if(hours >= 100) rank = { title: "ä¼èª¬", icon: "ğŸ‘‘" };
            else if(hours >= 50) rank = { title: "é”äºº", icon: "ğŸ”®" };
            else if(hours >= 20) rank = { title: "ç†Ÿç·´è€…", icon: "ğŸ“" };
            else if(hours >= 5) rank = { title: "åŠªåŠ›å®¶", icon: "ğŸ“˜" };
            else if(hours >= 1) rank = { title: "é§†ã‘å‡ºã—", icon: "ğŸ£" };
            document.getElementById('rankDisplay').innerText = `${rank.icon} ${rank.title}`;
        }

        // --- AI ---
        async function callGemini(prompt, systemPrompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if(!res.ok) throw new Error("API Error");
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "ãŠè¿”äº‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
                } catch (e) {
                    if(i === delays.length) return "Cãã‚“ï¼æ¥ç¶šãŒã†ã¾ãã„ã‹ãªã„ã¿ãŸã„ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã¾ãŸè©±ã—ã‹ã‘ã¦ã­ã€‚";
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        function appendMessage(role, text) {
            const container = document.getElementById('chatHistory');
            const msg = document.createElement('div');
            msg.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2`;
            msg.innerHTML = `
                <div class="flex max-w-[85%] ${role === 'user' ? 'flex-row-reverse' : 'flex-row'} items-start gap-3">
                    <div class="w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 mt-1 shadow-sm ${role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border text-indigo-500'}">
                        <i class="fas ${role === 'user' ? 'fa-user' : 'fa-robot'} text-sm"></i>
                    </div>
                    <div class="px-5 py-4 rounded-3xl text-sm leading-relaxed ${role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-gray-800 border border-gray-100 rounded-tl-none shadow-sm'}">
                        ${text}
                    </div>
                </div>
            `;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function initCoach() {
            const todayMins = sessions.filter(s => s.date === new Date().toLocaleDateString('sv-SE')).reduce((acc,s)=>acc+s.minutes, 0);
            let greet = "Cãã‚“ï¼ãŠç–²ã‚Œæ§˜ã€‚ã‚ãªãŸã®AIã‚³ãƒ¼ãƒã§ã™ã€‚";
            greet += todayMins === 0 ? " ã¾ã ä»Šæ—¥ã¯å­¦ç¿’ãŒå§‹ã¾ã£ã¦ã„ãªã„ã¿ãŸã„ã€‚å°‘ã—ã§ã‚‚ã„ã„ã‹ã‚‰ã€æœºã«å‘ã‹ã£ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ" : ` ä»Šæ—¥ã¯ã‚‚ã†${todayMins}åˆ†ã‚‚é ‘å¼µã£ã¦ã„ã¾ã™ã­ï¼ã“ã®èª¿å­ï¼`;
            appendMessage('assistant', greet);
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;
            appendMessage('user', text);
            input.value = '';
            document.getElementById('typingIndicator').classList.remove('hidden');
            const total = sessions.reduce((acc,s)=>acc+s.minutes, 0);
            const system = `ã‚ãªãŸã¯ã€ŒCãã‚“ã€ã®AIã‚³ãƒ¼ãƒã§ã™ã€‚å¸¸ã«ã€ŒCãã‚“ï¼ã€ã‹ã‚‰å§‹ã‚ã¦ã€‚å…·ä½“çš„ã§ãƒã‚¸ãƒ†ã‚£ãƒ–ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’200å­—ä»¥å†…ã§ã€‚ç¾åœ¨ã®ç´¯è¨ˆã¯${total}åˆ†ã§ã™ã€‚`;
            const response = await callGemini(text, system);
            document.getElementById('typingIndicator').classList.add('hidden');
            appendMessage('assistant', response);
        }

        function exportData() {
            const str = JSON.stringify(sessions, null, 2);
            const el = document.createElement('textarea');
            el.value = str; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
        }

        function importData() {
            try {
                const text = document.getElementById('importText').value;
                const parsed = JSON.parse(text);
                if(Array.isArray(parsed)) {
                    sessions = parsed;
                    saveToStorage();
                    toggleModal('dataModal');
                    alert("å¾©å…ƒã«æˆåŠŸã—ã¾ã—ãŸï¼");
                }
            } catch(e) { alert("æ­£ã—ã„å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"); }
        }

        window.onload = () => {
            document.getElementById('manualDate').value = new Date().toLocaleDateString('sv-SE');
            updateTimerDisplay();
            renderHistory();
            updateStats();
        };
    </script>
</body>
</html>
