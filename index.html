<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyLog - Cãã‚“å°‚ç”¨å­¦ç¿’ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body class="bg-slate-50 text-gray-800 pb-20">

    <!-- Header -->
    <header class="bg-white border-b sticky top-0 z-10 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-black text-indigo-600 flex items-center select-none">
                <i class="fas fa-book-open mr-2"></i> StudyLog
            </h1>
            <div class="flex gap-2">
                <button onclick="toggleModal('dataModal')" title="ãƒ‡ãƒ¼ã‚¿ç®¡ç†" class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                    <i class="fas fa-save text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-4 md:p-8">
        
        <!-- Timer Tab -->
        <div id="timerTab" class="tab-content active animate-in fade-in">
            <div class="flex flex-col items-center justify-center space-y-6 py-4">
                <div class="flex space-x-4 bg-gray-100 p-1 rounded-lg">
                    <button id="btnStudyMode" onclick="switchMode('study')" class="px-6 py-2 rounded-md font-bold transition-all bg-indigo-600 text-white shadow-md">å­¦ç¿’ (25åˆ†)</button>
                    <button id="btnBreakMode" onclick="switchMode('break')" class="px-6 py-2 rounded-md font-bold transition-all text-gray-500 hover:bg-gray-200">ä¼‘æ†© (5åˆ†)</button>
                </div>
                <div id="timerDisplay" class="text-7xl md:text-8xl font-mono font-bold tracking-wider text-indigo-600">25:00</div>
                <div class="w-full max-w-xs space-y-3 text-center">
                    <input type="text" id="timerSubject" placeholder="ç§‘ç›® (ä¾‹: è‹±èª)" class="w-full text-center border-b-2 border-gray-200 focus:border-indigo-500 outline-none py-2 bg-transparent transition-colors">
                    <input type="text" id="timerDetails" placeholder="è©³ç´° (ä¾‹: å˜èªæš—è¨˜)" class="w-full text-center text-sm border-b border-gray-100 focus:border-indigo-300 outline-none py-1 bg-transparent transition-colors">
                </div>
                <div class="flex space-x-6">
                    <button id="btnStartStop" onclick="toggleTimer()" class="flex items-center space-x-2 bg-gray-800 text-white px-8 py-4 rounded-full hover:bg-gray-700 active:scale-95 shadow-lg transition-transform">
                        <i id="playIcon" class="fas fa-play mr-2"></i>
                        <span id="playText" class="text-xl font-bold">é–‹å§‹</span>
                    </button>
                    <button onclick="resetTimer()" class="p-4 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors">
                        <i class="fas fa-undo-alt text-xl"></i>
                    </button>
                </div>
                <button id="btnSaveSession" onclick="saveTimerSession()" class="hidden animate-bounce flex items-center space-x-2 bg-green-500 text-white px-8 py-3 rounded-lg shadow-lg hover:bg-green-600 transition-colors">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span class="text-lg font-bold">å®Œäº†ã—ã¦è¨˜éŒ²</span>
                </button>
            </div>
        </div>

        <!-- Manual Tab -->
        <div id="manualTab" class="tab-content animate-in fade-in">
            <div class="max-w-md mx-auto bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-plus-circle mr-2 text-indigo-500"></i> å­¦ç¿’ã‚’è¨˜éŒ²</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">æ—¥ä»˜</label>
                        <input type="date" id="manualDate" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">ç§‘ç›®</label>
                            <input type="text" id="manualSubject" placeholder="æ•°å­¦" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">æ™‚é–“ (åˆ†)</label>
                            <input type="number" id="manualMinutes" min="1" placeholder="60" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">å†…å®¹ãƒ»ãƒ¡ãƒ¢</label>
                        <textarea id="manualDetails" placeholder="ä¾‹: ãƒ¯ãƒ¼ã‚¯ p.10-15" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none h-24 resize-none"></textarea>
                    </div>
                    <button onclick="saveManualSession()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl hover:bg-indigo-700 transition-all shadow-md flex justify-center items-center active:scale-[0.98]">
                        <i class="fas fa-save mr-2"></i> ä¿å­˜ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>

        <!-- Coach Tab -->
        <div id="coachTab" class="tab-content animate-in fade-in h-[calc(100vh-220px)] flex flex-col space-y-4">
            <div class="flex gap-4 shrink-0">
                <div class="flex-1 bg-white p-4 rounded-2xl border border-gray-100 flex items-center justify-between shadow-sm">
                    <div class="flex items-center"><i class="fas fa-fire text-orange-500 mr-2"></i> <span class="text-sm font-bold text-gray-500">ç¶™ç¶šä¸­</span></div>
                    <span id="streakDisplay" class="text-xl font-black text-gray-800">0æ—¥</span>
                </div>
                <div class="flex-1 bg-white p-4 rounded-2xl border border-gray-100 flex items-center justify-between shadow-sm">
                    <div class="flex items-center"><i class="fas fa-trophy text-yellow-500 mr-2"></i> <span class="text-sm font-bold text-gray-500">ãƒ©ãƒ³ã‚¯</span></div>
                    <span id="rankDisplay" class="text-lg font-black text-gray-800">ğŸŒ± è¦‹ç¿’ã„</span>
                </div>
            </div>
            <div class="flex-1 bg-white rounded-3xl border border-gray-200 shadow-sm flex flex-col overflow-hidden">
                <div id="chatHistory" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                    <!-- Messages will be injected here -->
                </div>
                <div id="typingIndicator" class="hidden px-4 py-2 bg-slate-50 text-xs text-gray-400">
                    <span class="loading-dots">âœ¨ ã‚³ãƒ¼ãƒãŒè€ƒãˆã¦ã„ã¾ã™</span>
                </div>
                <form onsubmit="handleChatSubmit(event)" class="p-3 bg-white border-t flex gap-2">
                    <input type="text" id="chatInput" placeholder="æ‚©ã¿ã‚’ç›¸è«‡ã—ã‚ˆã†..." class="flex-1 bg-gray-50 rounded-full px-5 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm transition-all">
                    <button type="submit" class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 transition-all">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content animate-in fade-in space-y-6">
            <div class="flex justify-between items-center bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                <p class="text-sm font-bold text-indigo-700">ç´¯è¨ˆå­¦ç¿’æ™‚é–“</p>
                <p id="totalMinutesDisplay" class="text-2xl font-black text-indigo-800">0 åˆ†</p>
            </div>
            <div id="historyList" class="space-y-4">
                <!-- History items will be injected here -->
            </div>
        </div>
    </main>

    <!-- Modal: Data Management -->
    <div id="dataModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-6 w-full max-w-lg shadow-2xl space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-black flex items-center"><i class="fas fa-save mr-2"></i> ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†</h3>
                <button onclick="toggleModal('dataModal')" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div class="p-4 bg-indigo-50 rounded-2xl flex items-center justify-between border border-indigo-100">
                    <div>
                        <p class="font-bold text-indigo-900">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</p>
                        <p class="text-xs text-indigo-700">å…¨è¨˜éŒ²ã‚’æ–‡å­—ã¨ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚</p>
                    </div>
                    <button onclick="exportData()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 hover:bg-indigo-700">
                        <i class="fas fa-download"></i> ã‚³ãƒ”ãƒ¼
                    </button>
                </div>
                <div class="space-y-2">
                    <p class="font-bold text-gray-800 ml-1">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</p>
                    <textarea id="importText" placeholder="ã“ã“ã«JSONãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..." class="w-full h-32 p-4 bg-gray-50 rounded-2xl border border-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none text-xs font-mono"></textarea>
                    <button onclick="importData()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold hover:bg-gray-900">
                        <i class="fas fa-upload mr-2"></i> ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Nav -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 z-40 shadow-lg">
        <button onclick="switchTab('timer')" class="nav-btn flex flex-col items-center p-2 w-full text-indigo-600"><i class="fas fa-clock"></i><span class="text-[10px] mt-1 font-bold">ã‚¿ã‚¤ãƒãƒ¼</span></button>
        <button onclick="switchTab('manual')" class="nav-btn flex flex-col items-center p-2 w-full text-gray-400"><i class="fas fa-plus-circle"></i><span class="text-[10px] mt-1 font-bold">å…¥åŠ›</span></button>
        <button onclick="switchTab('coach')" class="nav-btn flex flex-col items-center p-2 w-full text-gray-400"><i class="fas fa-sparkles"></i><span class="text-[10px] mt-1 font-bold">AI</span></button>
        <button onclick="switchTab('history')" class="nav-btn flex flex-col items-center p-2 w-full text-gray-400"><i class="fas fa-list"></i><span class="text-[10px] mt-1 font-bold">å±¥æ­´</span></button>
    </nav>

    <script>
        // --- State ---
        let sessions = JSON.parse(localStorage.getItem('studySessions_v2') || '[]');
        let currentTimer = { timeLeft: 25 * 60, isRunning: false, mode: 'study' };
        let timerInterval = null;
        const apiKey = ""; // Set at runtime
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

        // --- Core Functions ---
        function saveToStorage() {
            localStorage.setItem('studySessions_v2', JSON.stringify(sessions));
            renderHistory();
            updateStats();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            // Update Mobile Nav UI
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.replace('text-indigo-600', 'text-gray-400'));
            event.currentTarget.classList.replace('text-gray-400', 'text-indigo-600');

            if(tabId === 'coach' && document.getElementById('chatHistory').children.length === 0) {
                initCoach();
            }
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
            el.classList.toggle('flex');
        }

        // --- Timer Logic ---
        function updateTimerDisplay() {
            const m = Math.floor(currentTimer.timeLeft / 60);
            const s = currentTimer.timeLeft % 60;
            document.getElementById('timerDisplay').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function switchMode(mode) {
            currentTimer.mode = mode;
            currentTimer.isRunning = false;
            clearInterval(timerInterval);
            currentTimer.timeLeft = (mode === 'study' ? 25 : 5) * 60;
            
            const studyBtn = document.getElementById('btnStudyMode');
            const breakBtn = document.getElementById('btnBreakMode');
            const display = document.getElementById('timerDisplay');
            
            if(mode === 'study') {
                studyBtn.className = "px-6 py-2 rounded-md font-bold transition-all bg-indigo-600 text-white shadow-md";
                breakBtn.className = "px-6 py-2 rounded-md font-bold transition-all text-gray-500 hover:bg-gray-200";
                display.classList.replace('text-teal-500', 'text-indigo-600');
            } else {
                breakBtn.className = "px-6 py-2 rounded-md font-bold transition-all bg-teal-500 text-white shadow-md";
                studyBtn.className = "px-6 py-2 rounded-md font-bold transition-all text-gray-500 hover:bg-gray-200";
                display.classList.replace('text-indigo-600', 'text-teal-500');
            }
            
            updateTimerDisplay();
            document.getElementById('playIcon').className = "fas fa-play mr-2";
            document.getElementById('playText').innerText = "é–‹å§‹";
            document.getElementById('btnSaveSession').classList.add('hidden');
        }

        function toggleTimer() {
            currentTimer.isRunning = !currentTimer.isRunning;
            const icon = document.getElementById('playIcon');
            const text = document.getElementById('playText');
            
            if(currentTimer.isRunning) {
                icon.className = "fas fa-pause mr-2";
                text.innerText = "ä¸€æ™‚åœæ­¢";
                timerInterval = setInterval(() => {
                    currentTimer.timeLeft--;
                    updateTimerDisplay();
                    if(currentTimer.timeLeft <= 0) {
                        clearInterval(timerInterval);
                        currentTimer.isRunning = false;
                        document.getElementById('btnSaveSession').classList.remove('hidden');
                        alert(currentTimer.mode === 'study' ? "å­¦ç¿’çµ‚äº†ï¼ãŠç–²ã‚Œæ§˜ï¼" : "ä¼‘æ†©çµ‚äº†ï¼");
                    }
                }, 1000);
            } else {
                icon.className = "fas fa-play mr-2";
                text.innerText = "å†é–‹";
                clearInterval(timerInterval);
            }
        }

        function resetTimer() {
            switchMode(currentTimer.mode);
        }

        function saveTimerSession() {
            const minutes = currentTimer.mode === 'study' ? 25 : 5;
            const subject = document.getElementById('timerSubject').value || (currentTimer.mode === 'study' ? 'é›†ä¸­å­¦ç¿’' : 'ä¼‘æ†©');
            const details = document.getElementById('timerDetails').value;
            addSession(minutes, 'timer', subject, details);
            resetTimer();
            document.getElementById('timerSubject').value = '';
            document.getElementById('timerDetails').value = '';
        }

        // --- Data Functions ---
        function addSession(minutes, type, subject, details, customDate = null) {
            const session = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                date: customDate || new Date().toLocaleDateString('sv-SE'),
                timestamp: new Date().toISOString(),
                minutes: parseInt(minutes),
                type,
                subject: subject || 'å­¦ç¿’',
                details: details || ''
            };
            sessions.unshift(session);
            saveToStorage();
        }

        function saveManualSession() {
            const minutes = document.getElementById('manualMinutes').value;
            const date = document.getElementById('manualDate').value;
            if(!minutes || !date) return alert("æ—¥ä»˜ã¨æ™‚é–“ã¯å¿…é ˆã§ã™ï¼");
            
            addSession(minutes, 'manual', document.getElementById('manualSubject').value, document.getElementById('manualDetails').value, date);
            
            // Clear inputs
            ['manualMinutes', 'manualSubject', 'manualDetails'].forEach(id => document.getElementById(id).value = '');
            switchTab('history');
        }

        function deleteSession(id) {
            if(confirm("å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                sessions = sessions.filter(s => s.id !== id);
                saveToStorage();
            }
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            const grouped = sessions.reduce((acc, s) => {
                const d = s.date; if(!acc[d]) acc[d] = { total: 0, items: [] };
                acc[d].total += s.minutes; acc[d].items.push(s); return acc;
            }, {});
            
            const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
            
            if(sessions.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-400 py-20">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                return;
            }

            sortedDates.forEach(date => {
                const dayGroup = grouped[date];
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden animate-in fade-in";
                card.innerHTML = `
                    <div class="bg-slate-50 px-4 py-3 flex justify-between items-center">
                        <h4 class="font-bold text-gray-700 flex items-center"><i class="far fa-calendar-alt mr-2"></i> ${date}</h4>
                        <span class="text-sm font-bold text-gray-500">åˆè¨ˆ ${dayGroup.total} åˆ†</span>
                    </div>
                    <div class="divide-y divide-gray-50">
                        ${dayGroup.items.map(item => `
                            <div class="px-4 py-4 flex justify-between items-center group">
                                <div class="flex items-center space-x-4">
                                    <div class="p-2 rounded-lg ${item.type === 'timer' ? 'bg-teal-50 text-teal-600' : 'bg-orange-50 text-orange-600'}">
                                        <i class="fas ${item.type === 'timer' ? 'fa-clock' : 'fa-plus-circle'}"></i>
                                    </div>
                                    <div>
                                        <p class="font-bold text-gray-800">${item.subject}</p>
                                        <p class="text-xs text-gray-400">${item.details || 'è©³ç´°ãªã—'} â€¢ ${item.minutes}åˆ†</p>
                                    </div>
                                </div>
                                <button onclick="deleteSession('${item.id}')" class="text-gray-200 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-all">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function updateStats() {
            const total = sessions.reduce((acc, s) => acc + s.minutes, 0);
            document.getElementById('totalMinutesDisplay').innerText = `${total} åˆ†`;
            
            // Streak
            const uniqueDates = [...new Set(sessions.map(s => s.date))].sort((a,b) => new Date(b) - new Date(a));
            let streak = 0;
            const today = new Date().toLocaleDateString('sv-SE');
            const yesterday = new Date(Date.now() - 86400000).toLocaleDateString('sv-SE');
            
            if(uniqueDates[0] === today || uniqueDates[0] === yesterday) {
                streak = 1;
                for(let i=0; i < uniqueDates.length - 1; i++) {
                    const d1 = new Date(uniqueDates[i]);
                    const d2 = new Date(uniqueDates[i+1]);
                    if(Math.round((d1-d2)/(1000*60*60*24)) === 1) streak++;
                    else break;
                }
            }
            document.getElementById('streakDisplay').innerText = `${streak}æ—¥`;
            
            // Rank
            const hours = total / 60;
            let rank = { title: "è¦‹ç¿’ã„", icon: "ğŸŒ±" };
            if(hours >= 100) rank = { title: "ä¼èª¬", icon: "ğŸ‘‘" };
            else if(hours >= 50) rank = { title: "é”äºº", icon: "ğŸ”®" };
            else if(hours >= 20) rank = { title: "ç†Ÿç·´è€…", icon: "ğŸ“" };
            else if(hours >= 5) rank = { title: "åŠªåŠ›å®¶", icon: "ğŸ“˜" };
            else if(hours >= 1) rank = { title: "é§†ã‘å‡ºã—", icon: "ğŸ£" };
            
            document.getElementById('rankDisplay').innerText = `${rank.icon} ${rank.title}`;
        }

        // --- API & Chat Logic ---
        async function callGemini(prompt, systemPrompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            const delays = [1000, 2000, 4000, 8000, 16000];
            
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if(!res.ok) throw new Error("API Error");
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "ãŠè¿”äº‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
                } catch (e) {
                    if(i === delays.length) return "Cãã‚“ï¼æ¥ç¶šãŒã†ã¾ãã„ã‹ãªã„ã¿ãŸã„ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã¾ãŸè©±ã—ã‹ã‘ã¦ã­ã€‚";
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        function appendMessage(role, text) {
            const container = document.getElementById('chatHistory');
            const msg = document.createElement('div');
            msg.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2`;
            msg.innerHTML = `
                <div class="flex max-w-[85%] ${role === 'user' ? 'flex-row-reverse' : 'flex-row'} items-start gap-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-1 ${role === 'user' ? 'bg-indigo-600' : 'bg-white border shadow-sm'}">
                        <i class="fas ${role === 'user' ? 'fa-user text-white' : 'fa-robot text-indigo-500'} text-xs"></i>
                    </div>
                    <div class="px-4 py-3 rounded-2xl text-sm leading-relaxed ${role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-gray-800 border border-gray-100 rounded-tl-none shadow-sm'}">
                        ${text}
                    </div>
                </div>
            `;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        async function initCoach() {
            const todayMins = sessions.filter(s => s.date === new Date().toLocaleDateString('sv-SE')).reduce((acc,s)=>acc+s.minutes, 0);
            let greet = "Cãã‚“ï¼ãŠç–²ã‚Œæ§˜ã€‚AIã‚³ãƒ¼ãƒã§ã™ã€‚";
            greet += todayMins === 0 ? " ä»Šæ—¥ã¯ã¾ã å­¦ç¿’ãŒå§‹ã¾ã£ã¦ã„ãªã„ã¿ãŸã„ã ã­ã€‚ã¾ãšã¯5åˆ†ã‹ã‚‰å§‹ã‚ã‚ˆã†ï¼" : ` ä»Šæ—¥ã¯${todayMins}åˆ†ã‚‚é ‘å¼µã£ã¦ã„ã‚‹ã­ï¼`;
            appendMessage('assistant', greet);
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;
            
            appendMessage('user', text);
            input.value = '';
            document.getElementById('typingIndicator').classList.remove('hidden');

            const total = sessions.reduce((acc,s)=>acc+s.minutes, 0);
            const system = `ã‚ãªãŸã¯ã€ŒCãã‚“ã€ã®AIã‚³ãƒ¼ãƒã§ã™ã€‚å¸¸ã«ã€ŒCãã‚“ï¼ã€ã‹ã‚‰å§‹ã‚ã¦ã€‚å…·ä½“çš„ã§å‰å‘ããªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’200å­—ä»¥å†…ã§ã€‚ç¾åœ¨ã®ç´¯è¨ˆã¯${total}åˆ†ã§ã™ã€‚`;
            
            const response = await callGemini(text, system);
            document.getElementById('typingIndicator').classList.add('hidden');
            appendMessage('assistant', response);
        }

        // --- Backup & Restore ---
        function exportData() {
            const str = JSON.stringify(sessions, null, 2);
            const el = document.createElement('textarea');
            el.value = str; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ãƒ¡ãƒ¢å¸³ãªã©ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
        }

        function importData() {
            try {
                const text = document.getElementById('importText').value;
                const parsed = JSON.parse(text);
                if(Array.isArray(parsed)) {
                    sessions = parsed;
                    saveToStorage();
                    toggleModal('dataModal');
                    alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                }
            } catch(e) { alert("æ­£ã—ã„JSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"); }
        }

        // --- Init ---
        window.onload = () => {
            document.getElementById('manualDate').value = new Date().toLocaleDateString('sv-SE');
            updateTimerDisplay();
            renderHistory();
            updateStats();
        };
    </script>
</body>
</html>
