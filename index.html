<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyLog - Cくん専用学習管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
        @media (min-width: 768px) { .desktop-nav-active { background-color: #f3f4f6; color: #4f46e5; } }
    </style>
</head>
<body class="bg-slate-50 text-gray-800 pb-20 md:pb-0">

    <!-- Header -->
    <header class="bg-white border-b sticky top-0 z-10 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-black text-indigo-600 flex items-center select-none">
                <i class="fas fa-book-open mr-2"></i> StudyLog
            </h1>
            
            <nav class="hidden md:flex items-center space-x-1">
                <button onclick="switchTab('timer')" class="nav-btn-desktop px-4 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition-all desktop-nav-active" data-tab="timer">タイマー</button>
                <button onclick="switchTab('manual')" class="nav-btn-desktop px-4 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition-all" data-tab="manual">手動入力</button>
                <button onclick="switchTab('coach')" class="nav-btn-desktop px-4 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition-all" data-tab="coach">AIコーチ</button>
                <button onclick="switchTab('history')" class="nav-btn-desktop px-4 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition-all" data-tab="history">履歴</button>
            </nav>

            <div class="flex gap-2">
                <button onclick="toggleModal('settingsModal')" title="設定" class="p-2 text-gray-400 hover:text-indigo-600 transition-colors">
                    <i class="fas fa-cog text-lg"></i>
                </button>
                <button onclick="toggleModal('dataModal')" title="データ管理" class="p-2 text-gray-400 hover:text-indigo-600 transition-colors">
                    <i class="fas fa-save text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-4 md:p-12">
        <!-- Timer Tab -->
        <div id="timerTab" class="tab-content active animate-in fade-in text-center">
            <div id="timerDisplay" class="text-8xl md:text-9xl font-mono font-bold text-indigo-600 mb-8">25:00</div>
            <div class="flex justify-center space-x-4 mb-8">
                <button id="btnStartStop" onclick="toggleTimer()" class="bg-indigo-600 text-white px-10 py-4 rounded-full font-bold text-xl shadow-lg">開始</button>
                <button onclick="resetTimer()" class="bg-gray-200 text-gray-600 px-6 py-4 rounded-full font-bold">リセット</button>
            </div>
            <div id="btnSaveSession" class="hidden"><button onclick="saveTimerSession()" class="bg-green-500 text-white px-8 py-3 rounded-xl font-bold">記録を保存</button></div>
        </div>

        <!-- Manual Tab -->
        <div id="manualTab" class="tab-content animate-in fade-in">
            <div class="max-w-xl mx-auto bg-white p-8 rounded-3xl shadow-xl space-y-4">
                <h3 class="text-2xl font-black mb-4">手動入力</h3>
                <input type="date" id="manualDate" class="w-full p-4 bg-gray-50 rounded-xl outline-none">
                <input type="number" id="manualMinutes" placeholder="時間(分)" class="w-full p-4 bg-gray-50 rounded-xl outline-none">
                <input type="text" id="manualSubject" placeholder="科目名" class="w-full p-4 bg-gray-50 rounded-xl outline-none">
                <button onclick="saveManualSession()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold">保存</button>
            </div>
        </div>

        <!-- Coach Tab -->
        <div id="coachTab" class="tab-content animate-in fade-in h-[500px] flex flex-col bg-white rounded-3xl shadow-xl overflow-hidden border">
            <div id="chatHistory" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50"></div>
            <div id="typingIndicator" class="hidden px-6 py-2 text-xs text-indigo-500 font-bold"><span class="loading-dots">AIが考え中</span></div>
            <form onsubmit="handleChatSubmit(event)" class="p-4 border-t flex gap-2">
                <input type="text" id="chatInput" placeholder="AIコーチに相談..." class="flex-1 p-3 bg-gray-100 rounded-xl outline-none">
                <button type="submit" class="bg-indigo-600 text-white px-6 rounded-xl"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content animate-in fade-in space-y-4">
            <div class="bg-indigo-600 p-6 rounded-3xl text-white">
                <p class="font-bold">累計学習時間: <span id="totalMinutesDisplay">0</span> 分</p>
            </div>
            <div id="historyList" class="space-y-4"></div>
        </div>
    </main>

    <!-- Modal: Settings (API KEY) -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md space-y-6">
            <h3 class="text-xl font-black">AIコーチ設定</h3>
            <p class="text-sm text-gray-500">GitHubで動作させるには Gemini API キーが必要です。</p>
            <input type="password" id="userApiKey" placeholder="APIキーを入力 (AIを使わないなら空でOK)" class="w-full p-4 bg-gray-50 rounded-xl border outline-none">
            <p class="text-[10px] text-gray-400">※キーはブラウザにのみ保存され、サーバーへは送られません。</p>
            <div class="flex gap-2">
                <button onclick="saveSettings()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">保存</button>
                <button onclick="toggleModal('settingsModal')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Modal: Data Management -->
    <div id="dataModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md space-y-4">
            <h3 class="text-xl font-black">データ管理</h3>
            <button onclick="exportData()" class="w-full bg-gray-100 py-3 rounded-xl font-bold">データを書き出し</button>
            <textarea id="importText" placeholder="JSONを貼り付け" class="w-full h-32 p-4 bg-gray-50 rounded-xl text-xs"></textarea>
            <button onclick="importData()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">読み込み</button>
            <button onclick="toggleModal('dataModal')" class="w-full py-2 text-gray-400">閉じる</button>
        </div>
    </div>

    <!-- Mobile Nav -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 z-40">
        <button onclick="switchTab('timer')" class="nav-btn-mobile flex flex-col items-center p-2 w-full text-indigo-600" data-tab="timer"><i class="fas fa-clock"></i></button>
        <button onclick="switchTab('manual')" class="nav-btn-mobile flex flex-col items-center p-2 w-full text-gray-400" data-tab="manual"><i class="fas fa-plus-circle"></i></button>
        <button onclick="switchTab('coach')" class="nav-btn-mobile flex flex-col items-center p-2 w-full text-gray-400" data-tab="coach"><i class="fas fa-robot"></i></button>
        <button onclick="switchTab('history')" class="nav-btn-mobile flex flex-col items-center p-2 w-full text-gray-400" data-tab="history"><i class="fas fa-list"></i></button>
    </nav>

    <script>
        // --- State ---
        let sessions = JSON.parse(localStorage.getItem('studySessions_v2') || '[]');
        let currentTimer = { timeLeft: 25 * 60, isRunning: false };
        let timerInterval = null;
        let internalApiKey = ""; // This will be set from localStorage or auto-injected

        // --- Init ---
        window.onload = () => {
            // Retrieve saved key if exists
            internalApiKey = localStorage.getItem('gemini_api_key') || "";
            document.getElementById('userApiKey').value = internalApiKey;
            document.getElementById('manualDate').value = new Date().toLocaleDateString('sv-SE');
            updateStats();
            renderHistory();
        };

        function saveSettings() {
            const val = document.getElementById('userApiKey').value.trim();
            localStorage.setItem('gemini_api_key', val);
            internalApiKey = val;
            alert("設定を保存しました。AIコーチが使えるようになります。");
            toggleModal('settingsModal');
        }

        // --- Tabs ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId + 'Tab').classList.add('active');
            document.querySelectorAll('.nav-btn-desktop').forEach(btn => btn.classList.toggle('desktop-nav-active', btn.dataset.tab === tabId));
            if(tabId === 'coach' && document.getElementById('chatHistory').children.length === 0) initCoach();
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
            el.classList.toggle('flex');
        }

        // --- Timer ---
        function toggleTimer() {
            currentTimer.isRunning = !currentTimer.isRunning;
            const btn = document.getElementById('btnStartStop');
            if(currentTimer.isRunning) {
                btn.innerText = "一時停止";
                timerInterval = setInterval(() => {
                    currentTimer.timeLeft--;
                    const m = Math.floor(currentTimer.timeLeft / 60);
                    const s = currentTimer.timeLeft % 60;
                    document.getElementById('timerDisplay').innerText = `${m}:${s.toString().padStart(2, '0')}`;
                    if(currentTimer.timeLeft <= 0) {
                        clearInterval(timerInterval);
                        document.getElementById('btnSaveSession').classList.remove('hidden');
                    }
                }, 1000);
            } else {
                btn.innerText = "再開";
                clearInterval(timerInterval);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            currentTimer = { timeLeft: 25 * 60, isRunning: false };
            document.getElementById('timerDisplay').innerText = "25:00";
            document.getElementById('btnStartStop').innerText = "開始";
            document.getElementById('btnSaveSession').classList.add('hidden');
        }

        function saveTimerSession() {
            addSession(25, 'timer', '集中学習', '');
            resetTimer();
        }

        function addSession(minutes, type, subject, details, date = null) {
            sessions.unshift({ id: Date.now(), date: date || new Date().toLocaleDateString('sv-SE'), minutes, type, subject, details });
            localStorage.setItem('studySessions_v2', JSON.stringify(sessions));
            updateStats();
            renderHistory();
        }

        function saveManualSession() {
            const mins = document.getElementById('manualMinutes').value;
            const date = document.getElementById('manualDate').value;
            if(!mins || !date) return alert("入力してください");
            addSession(mins, 'manual', document.getElementById('manualSubject').value, '', date);
            switchTab('history');
        }

        function updateStats() {
            const total = sessions.reduce((acc, s) => acc + parseInt(s.minutes), 0);
            document.getElementById('totalMinutesDisplay').innerText = total;
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = sessions.map(s => `
                <div class="bg-white p-4 rounded-xl border flex justify-between">
                    <div><b>${s.subject}</b> (${s.date})</div>
                    <div class="text-indigo-600 font-bold">${s.minutes}分</div>
                </div>
            `).join('');
        }

        // --- AI API Logic ---
        async function callGemini(prompt, systemPrompt) {
            // Critical: Check if key exists
            const activeKey = internalApiKey || ""; 
            if(!activeKey) return "Cくん！右上の設定（歯車アイコン）から Gemini API キーを設定してね。無料で取得できるよ！";

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const delays = [1000, 2000, 4000, 8000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                    if(!res.ok) throw new Error("API Error");
                    const data = await res.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    if(i === delays.length) return "Cくん！接続がうまくいかないみたい。キーが正しいか確認してみてね。";
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `p-3 rounded-xl max-w-[80%] ${role === 'user' ? 'bg-indigo-600 text-white ml-auto' : 'bg-white border mr-auto'}`;
            div.innerText = text;
            document.getElementById('chatHistory').appendChild(div);
            document.getElementById('chatHistory').scrollTop = 99999;
        }

        function initCoach() { appendMessage('assistant', "Cくん！お疲れ様。右上の設定からAPIキーを入力すれば、私と話せるようになるよ！"); }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;
            appendMessage('user', text);
            input.value = '';
            document.getElementById('typingIndicator').classList.remove('hidden');
            const response = await callGemini(text, "あなたはCくんのAIコーチです。常にCくん！から始めて。");
            document.getElementById('typingIndicator').classList.add('hidden');
            appendMessage('assistant', response);
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(sessions)], {type: 'application/json'});
            alert("データをコピーしました。JSON: " + JSON.stringify(sessions));
        }

        function importData() {
            sessions = JSON.parse(document.getElementById('importText').value);
            localStorage.setItem('studySessions_v2', JSON.stringify(sessions));
            renderHistory();
            updateStats();
        }
    </script>
</body>
</html>
